---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import PromoBar from '../../components/PromoBar.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import ProductGrid from '../../components/ProductGrid.astro';
import StyleNotes from '../../components/StyleNotes.astro';
import KeepExploring from '../../components/KeepExploring.astro';

// Import outfit data
let outfits = [];
try {
  const data = await import('../../data/outfits.json');
  outfits = data.default || [];
} catch (e) {
  console.log('No outfit data found');
}

// Get static paths for all outfits
export async function getStaticPaths() {
  let outfits = [];
  try {
    const data = await import('../../data/outfits.json');
    outfits = data.default || [];
  } catch (e) {
    return [];
  }
  
  return outfits.map(outfit => ({
    params: { slug: outfit.slug },
    props: { outfit }
  }));
}

const { outfit } = Astro.props;

if (!outfit) {
  return Astro.redirect('/');
}

const title = outfit.seoTitle || 'Shop This Look - Style Finds';
const description = outfit.metaDescription || `Discover this ${outfit.season} outfit and shop the items below.`;
const url = `${Astro.site}outfit/${outfit.slug}`;
const image = outfit.mainImage;
---

<BaseLayout title={title} description={description} image={image} url={url}>
  <Header showBack={true} backUrl="/" />
  
  <main class="max-w-6xl mx-auto px-4 py-4">
    <!-- Top Section: Image + Title/Description -->
    <div class="flex flex-row gap-4 md:gap-6 mb-4">
      <!-- Main Outfit Image -->
      <div class="relative group flex-shrink-0">
        <div class="w-[160px] md:w-[220px] rounded-lg overflow-hidden relative bg-stone-50 dark:bg-neutral-800" style="aspect-ratio: 2/3;">
          <img 
            src={outfit.mainImage}
            alt={outfit.mainImageAlt || `${outfit.season} outfit inspiration`}
            class="w-full h-full object-contain"
          />
          <!-- Pin Button -->
          <button 
            onclick={`window.pinOutfit('${outfit.mainImage}', '${title.replace(/'/g, "\\'")}', '/outfit/${outfit.slug}')`}
            class="absolute top-2 right-2 bg-white hover:bg-white/90 p-1.5 rounded-full shadow-lg"
            aria-label="Pin this outfit"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="17" x2="12" y2="22"></line>
              <path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Title + Description -->
      <div class="flex-1 flex flex-col">
        <h1 class="text-base md:text-xl font-medium mb-2 md:mb-3 leading-tight text-stone-800 dark:text-white">
          {outfit.seoTitle || 'Shop This Look'}
        </h1>
        <p class="text-xs md:text-sm mb-3 md:mb-4 leading-relaxed text-stone-600 dark:text-neutral-300">
          {outfit.metaDescription || `Discover this ${outfit.season} outfit and shop the items below.`}
        </p>
        <p class="text-xs font-medium mb-3 md:mb-4 text-stone-500 dark:text-neutral-400">
          {(outfit.items || []).length} Links
        </p>
        
        <!-- Desktop Share Buttons -->
        <div class="mt-auto">
          <ShareButtons url={url} variant="desktop" />
        </div>
      </div>
    </div>
    
    <!-- Mobile Share Buttons -->
    <ShareButtons url={url} variant="mobile" />
    
    <!-- Divider -->
    <div class="border-t mb-3 border-stone-200 dark:border-neutral-700"></div>
    
    <!-- Outfit Page Promo Banner -->
    <div class="mb-4">
      <PromoBar variant="outfit" />
    </div>
    
    <!-- Product Grid -->
    <ProductGrid items={outfit.items || []} outfitId={outfit.id} />
    
    <!-- Style Notes -->
    <StyleNotes content={outfit.fullSeoDescription} />
    
    <!-- Keep Exploring -->
    <KeepExploring outfits={outfits} currentOutfitId={outfit.id} />
    
    <!-- Exit Intent Banner -->
    <div class="mt-8">
      <PromoBar variant="exit" />
    </div>
  </main>
</BaseLayout>
