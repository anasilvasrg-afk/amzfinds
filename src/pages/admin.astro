---
import BaseLayout from '../layouts/BaseLayout.astro';

const title = "Admin - Style Finds";
const description = "Admin panel for managing outfits";
---

<BaseLayout title={title} description={description}>
  <div id="admin-app"></div>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
  
  <!-- React for Admin Panel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAgBxBaVmC07cJJCnoSmxhNFx_-dd3Cbds",
      authDomain: "shop-website-c1a5f.firebaseapp.com",
      projectId: "shop-website-c1a5f",
      storageBucket: "shop-website-c1a5f.firebasestorage.app",
      messagingSenderId: "303465721440",
      appId: "1:303465721440:web:74dd05748db813c8bc9d05"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    
    // REPLACE THIS WITH YOUR NETLIFY BUILD HOOK URL
    const NETLIFY_BUILD_HOOK = 'YOUR_NETLIFY_BUILD_HOOK_URL_HERE';
    
    // Icons
    const X = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
    const Trash = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
    const Edit = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
    const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const Copy = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
    
    // Login Component
    const LoginForm = ({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          await auth.signInWithEmailAndPassword(email, password);
          onLogin();
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };
      
      return (
        <div className="min-h-screen flex items-center justify-center bg-stone-50 p-4">
          <div className="bg-white rounded-2xl p-8 w-full max-w-md shadow-lg">
            <h1 className="text-2xl font-light text-center mb-6">Admin Login</h1>
            <form onSubmit={handleSubmit} className="space-y-4">
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full p-3 border border-stone-200 rounded-lg"
                required
              />
              <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full p-3 border border-stone-200 rounded-lg"
                required
              />
              {error && <p className="text-red-500 text-sm">{error}</p>}
              <button
                type="submit"
                disabled={loading}
                className="w-full py-3 bg-stone-800 text-white rounded-lg hover:bg-stone-900 disabled:opacity-50"
              >
                {loading ? 'Logging in...' : 'Login'}
              </button>
            </form>
          </div>
        </div>
      );
    };
    
    // Outfit Modal
    const OutfitModal = ({ outfit, onSave, onClose }) => {
      const [formData, setFormData] = useState(outfit || {
        mainImage: '', season: 'fall', slug: '', seoTitle: '', metaDescription: '',
        mainImageAlt: '', fullSeoDescription: '', outfitCode: '', items: []
      });
      const [newItem, setNewItem] = useState({ name: '', image: '', link: '', altText: '' });
      const [saving, setSaving] = useState(false);
      const [uploading, setUploading] = useState(false);
      const [uploadingItem, setUploadingItem] = useState(false);
      
      const generateSlug = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      
      const autoGenerateSlug = (code, title, season) => {
        const parts = [];
        if (code) parts.push(code);
        if (title) parts.push(generateSlug(title));
        else parts.push(season + '-outfit');
        return parts.join('-');
      };
      
      useEffect(() => {
        if (!outfit) {
          const newSlug = autoGenerateSlug(formData.outfitCode, formData.seoTitle, formData.season);
          setFormData(prev => ({ ...prev, slug: newSlug }));
        }
      }, [formData.outfitCode, formData.seoTitle, formData.season]);
      
      const compressImage = (file, maxWidth = 1200, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              canvas.toBlob((blob) => {
                resolve(new File([blob], file.name, { type: 'image/jpeg' }));
              }, 'image/jpeg', quality);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };
      
      const handleMainImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        setUploading(true);
        try {
          const compressed = await compressImage(file, 1200, 0.85);
          const ref = storage.ref().child(`outfits/${Date.now()}_${file.name.replace(/\.[^/.]+$/, '')}.jpg`);
          await ref.put(compressed);
          const url = await ref.getDownloadURL();
          setFormData({ ...formData, mainImage: url });
        } catch (err) {
          alert('Upload failed: ' + err.message);
        }
        setUploading(false);
      };
      
      const handleItemImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        setUploadingItem(true);
        try {
          const compressed = await compressImage(file, 800, 0.8);
          const ref = storage.ref().child(`products/${Date.now()}_${file.name.replace(/\.[^/.]+$/, '')}.jpg`);
          await ref.put(compressed);
          const url = await ref.getDownloadURL();
          setNewItem({ ...newItem, image: url });
        } catch (err) {
          alert('Upload failed: ' + err.message);
        }
        setUploadingItem(false);
      };
      
      const addItem = () => {
        if (newItem.name && newItem.image && newItem.link) {
          setFormData({ ...formData, items: [...formData.items, { ...newItem }] });
          setNewItem({ name: '', image: '', link: '', altText: '' });
        }
      };
      
      const removeItem = (idx) => {
        setFormData({ ...formData, items: formData.items.filter((_, i) => i !== idx) });
      };
      
      const handleSave = async () => {
        if (!formData.mainImage) {
          alert('Please add a main image');
          return;
        }
        setSaving(true);
        const finalSlug = formData.slug || autoGenerateSlug(formData.outfitCode, formData.seoTitle, formData.season);
        const data = {
          ...formData,
          slug: finalSlug,
          dateAdded: outfit?.dateAdded || new Date().toISOString()
        };
        await onSave(data);
        setSaving(false);
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-2xl p-6 w-full max-w-2xl my-8 relative max-h-[90vh] overflow-y-auto">
            <button onClick={onClose} className="absolute top-4 right-4 text-stone-500 hover:text-stone-700"><X /></button>
            <h2 className="text-2xl font-light mb-6">{outfit ? 'Edit Outfit' : 'Add New Outfit'}</h2>
            
            <div className="space-y-4">
              {/* Main Image */}
              <div>
                <label className="block text-sm font-medium mb-2">Main Outfit Image *</label>
                <div className="flex gap-2 items-center">
                  <input type="file" accept="image/*" onChange={handleMainImageUpload} className="flex-1 p-2 border rounded-lg text-sm" />
                  {uploading && <span className="text-sm text-stone-500">Uploading...</span>}
                </div>
                <input
                  type="text"
                  placeholder="Or paste image URL"
                  value={formData.mainImage}
                  onChange={(e) => setFormData({ ...formData, mainImage: e.target.value })}
                  className="w-full mt-2 p-2 border rounded-lg text-sm"
                />
                {formData.mainImage && (
                  <img src={formData.mainImage} alt="Preview" className="mt-2 w-32 h-40 object-cover rounded" />
                )}
              </div>
              
              {/* Season & Code */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2">Season</label>
                  <select
                    value={formData.season}
                    onChange={(e) => setFormData({ ...formData, season: e.target.value })}
                    className="w-full p-2 border rounded-lg"
                  >
                    <option value="spring">Spring</option>
                    <option value="summer">Summer</option>
                    <option value="fall">Fall</option>
                    <option value="winter">Winter</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Outfit Code</label>
                  <input
                    type="text"
                    value={formData.outfitCode}
                    onChange={(e) => setFormData({ ...formData, outfitCode: e.target.value })}
                    className="w-full p-2 border rounded-lg"
                    placeholder="e.g., 1225"
                  />
                </div>
              </div>
              
              {/* Slug */}
              <div>
                <label className="block text-sm font-medium mb-2">URL Slug (auto-generated)</label>
                <input
                  type="text"
                  value={formData.slug}
                  onChange={(e) => setFormData({ ...formData, slug: e.target.value })}
                  className="w-full p-2 border rounded-lg bg-stone-50"
                />
              </div>
              
              {/* SEO Title */}
              <div>
                <label className="block text-sm font-medium mb-2">SEO Title ({formData.seoTitle?.length || 0}/60)</label>
                <input
                  type="text"
                  value={formData.seoTitle}
                  onChange={(e) => setFormData({ ...formData, seoTitle: e.target.value })}
                  className="w-full p-2 border rounded-lg"
                  placeholder="e.g., Cozy Fall Outfit - Sweater & Jeans Look"
                  maxLength={60}
                />
              </div>
              
              {/* Meta Description */}
              <div>
                <label className="block text-sm font-medium mb-2">Meta Description ({formData.metaDescription?.length || 0}/160)</label>
                <textarea
                  value={formData.metaDescription}
                  onChange={(e) => setFormData({ ...formData, metaDescription: e.target.value })}
                  className="w-full p-2 border rounded-lg"
                  rows={2}
                  placeholder="Brief description for Pinterest and search..."
                  maxLength={160}
                />
              </div>
              
              {/* Alt Text */}
              <div>
                <label className="block text-sm font-medium mb-2">Main Image Alt Text</label>
                <input
                  type="text"
                  value={formData.mainImageAlt}
                  onChange={(e) => setFormData({ ...formData, mainImageAlt: e.target.value })}
                  className="w-full p-2 border rounded-lg"
                  placeholder="Describe the outfit for accessibility"
                />
              </div>
              
              {/* Full SEO Description (Style Notes) */}
              <div>
                <label className="block text-sm font-medium mb-2">Style Notes (Full Description)</label>
                <textarea
                  value={formData.fullSeoDescription}
                  onChange={(e) => setFormData({ ...formData, fullSeoDescription: e.target.value })}
                  className="w-full p-2 border rounded-lg"
                  rows={4}
                  placeholder="Detailed style notes shown on the outfit page..."
                />
              </div>
              
              {/* Product Items */}
              <div>
                <label className="block text-sm font-medium mb-2">Product Items ({formData.items?.length || 0})</label>
                
                {/* Existing Items */}
                {formData.items?.map((item, idx) => (
                  <div key={idx} className="flex items-center gap-2 p-2 bg-stone-50 rounded-lg mb-2">
                    <img src={item.image} alt={item.name} className="w-12 h-12 object-cover rounded" />
                    <div className="flex-1">
                      <p className="text-sm font-medium">{item.name}</p>
                      <p className="text-xs text-stone-500 truncate">{item.link}</p>
                    </div>
                    <button onClick={() => removeItem(idx)} className="text-red-500"><Trash /></button>
                  </div>
                ))}
                
                {/* Add New Item */}
                <div className="p-3 border border-dashed rounded-lg space-y-2">
                  <input
                    type="text"
                    placeholder="Item Name"
                    value={newItem.name}
                    onChange={(e) => setNewItem({ ...newItem, name: e.target.value })}
                    className="w-full p-2 border rounded text-sm"
                  />
                  <div className="flex gap-2">
                    <input type="file" accept="image/*" onChange={handleItemImageUpload} className="flex-1 p-2 border rounded text-sm" />
                    {uploadingItem && <span className="text-sm text-stone-500">Uploading...</span>}
                  </div>
                  <input
                    type="text"
                    placeholder="Or paste image URL"
                    value={newItem.image}
                    onChange={(e) => setNewItem({ ...newItem, image: e.target.value })}
                    className="w-full p-2 border rounded text-sm"
                  />
                  <input
                    type="text"
                    placeholder="Amazon Affiliate Link"
                    value={newItem.link}
                    onChange={(e) => setNewItem({ ...newItem, link: e.target.value })}
                    className="w-full p-2 border rounded text-sm"
                  />
                  <button
                    onClick={addItem}
                    disabled={!newItem.name || !newItem.image || !newItem.link}
                    className="w-full py-2 bg-stone-200 rounded text-sm hover:bg-stone-300 disabled:opacity-50"
                  >
                    + Add Item
                  </button>
                </div>
              </div>
              
              {/* Actions */}
              <div className="flex gap-3 pt-4">
                <button onClick={onClose} className="flex-1 py-3 border border-stone-200 rounded-lg hover:bg-stone-50">
                  Cancel
                </button>
                <button
                  onClick={handleSave}
                  disabled={saving || !formData.mainImage}
                  className="flex-1 py-3 bg-stone-800 text-white rounded-lg hover:bg-stone-900 disabled:opacity-50"
                >
                  {saving ? 'Saving...' : 'Save Outfit'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };
    
    // Main Admin App
    const AdminApp = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [outfits, setOutfits] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [editingOutfit, setEditingOutfit] = useState(null);
      const [publishing, setPublishing] = useState(false);
      const [publishStatus, setPublishStatus] = useState('');
      
      useEffect(() => {
        const unsubAuth = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return () => unsubAuth();
      }, []);
      
      useEffect(() => {
        if (user) {
          const unsubOutfits = db.collection('outfits').orderBy('dateAdded', 'desc').onSnapshot((snapshot) => {
            setOutfits(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });
          return () => unsubOutfits();
        }
      }, [user]);
      
      const saveOutfit = async (data) => {
        try {
          if (editingOutfit && editingOutfit.id && !editingOutfit._isDuplicate) {
            await db.collection('outfits').doc(editingOutfit.id).update(data);
          } else {
            await db.collection('outfits').add(data);
          }
          setShowModal(false);
          setEditingOutfit(null);
        } catch (err) {
          alert('Error saving: ' + err.message);
        }
      };
      
      const deleteOutfit = async (id) => {
        if (window.confirm('Are you sure you want to delete this outfit?')) {
          await db.collection('outfits').doc(id).delete();
        }
      };
      
      const duplicateOutfit = (outfit) => {
        const dup = {
          ...outfit,
          seoTitle: `${outfit.seoTitle || 'Outfit'} (Copy)`,
          slug: `${outfit.slug}-copy-${Date.now()}`,
          outfitCode: outfit.outfitCode ? `${outfit.outfitCode}-copy` : '',
          dateAdded: new Date().toISOString(),
          _isDuplicate: true
        };
        delete dup.id;
        setEditingOutfit(dup);
        setShowModal(true);
      };
      
      const publishSite = async () => {
        if (NETLIFY_BUILD_HOOK === 'YOUR_NETLIFY_BUILD_HOOK_URL_HERE') {
          alert('Please set up your Netlify Build Hook first!\n\n1. Go to Netlify > Site settings > Build & deploy > Build hooks\n2. Create a new hook named "Publish Site"\n3. Copy the URL and replace YOUR_NETLIFY_BUILD_HOOK_URL_HERE in the admin.astro file');
          return;
        }
        
        setPublishing(true);
        setPublishStatus('Triggering build...');
        
        try {
          const response = await fetch(NETLIFY_BUILD_HOOK, { method: 'POST' });
          if (response.ok) {
            setPublishStatus('‚úÖ Build triggered! Site will update in 1-2 minutes.');
            setTimeout(() => setPublishStatus(''), 5000);
          } else {
            setPublishStatus('‚ùå Failed to trigger build');
          }
        } catch (err) {
          setPublishStatus('‚ùå Error: ' + err.message);
        }
        
        setPublishing(false);
      };
      
      if (loading) {
        return <div className="min-h-screen flex items-center justify-center">Loading...</div>;
      }
      
      if (!user) {
        return <LoginForm onLogin={() => {}} />;
      }
      
      return (
        <div className="min-h-screen bg-stone-50">
          {/* Header */}
          <header className="bg-white border-b border-stone-200 sticky top-0 z-40">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <h1 className="text-xl font-light tracking-wider">STYLE FINDS ADMIN</h1>
              <div className="flex items-center gap-3">
                <button
                  onClick={publishSite}
                  disabled={publishing}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center gap-2"
                >
                  {publishing ? 'Publishing...' : 'üöÄ Publish Site'}
                </button>
                <button
                  onClick={() => { setEditingOutfit(null); setShowModal(true); }}
                  className="px-4 py-2 bg-stone-800 text-white rounded-lg hover:bg-stone-900 flex items-center gap-2"
                >
                  <Plus /> Add Outfit
                </button>
                <button onClick={() => auth.signOut()} className="text-stone-500 hover:text-stone-700">
                  Logout
                </button>
              </div>
            </div>
            {publishStatus && (
              <div className="bg-stone-100 px-4 py-2 text-center text-sm">{publishStatus}</div>
            )}
          </header>
          
          {/* Outfit Grid */}
          <main className="max-w-6xl mx-auto px-4 py-6">
            <p className="text-sm text-stone-500 mb-4">{outfits.length} outfits</p>
            
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
              {outfits.map(outfit => (
                <div key={outfit.id} className="bg-white rounded-lg overflow-hidden shadow-sm border border-stone-200">
                  <div className="relative" style={{ aspectRatio: '2/3' }}>
                    <img src={outfit.mainImage} alt={outfit.seoTitle || 'Outfit'} className="w-full h-full object-cover" />
                  </div>
                  <div className="p-2">
                    <p className="text-xs font-medium truncate">{outfit.seoTitle || outfit.season + ' outfit'}</p>
                    <p className="text-xs text-stone-400">{outfit.season}</p>
                    <div className="flex gap-1 mt-2">
                      <button
                        onClick={() => { setEditingOutfit(outfit); setShowModal(true); }}
                        className="flex-1 p-1.5 bg-stone-100 rounded text-xs hover:bg-stone-200"
                      >
                        <Edit />
                      </button>
                      <button
                        onClick={() => duplicateOutfit(outfit)}
                        className="flex-1 p-1.5 bg-blue-100 rounded text-xs hover:bg-blue-200 text-blue-600"
                      >
                        <Copy />
                      </button>
                      <button
                        onClick={() => deleteOutfit(outfit.id)}
                        className="flex-1 p-1.5 bg-red-100 rounded text-xs hover:bg-red-200 text-red-600"
                      >
                        <Trash />
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </main>
          
          {/* Modal */}
          {showModal && (
            <OutfitModal
              outfit={editingOutfit}
              onSave={saveOutfit}
              onClose={() => { setShowModal(false); setEditingOutfit(null); }}
            />
          )}
        </div>
      );
    };
    
    ReactDOM.render(<AdminApp />, document.getElementById('admin-app'));
  </script>
</BaseLayout>
